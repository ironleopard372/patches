From de4ce1e045804d7ffe8c95d9c9849fac5c8798ca Mon Sep 17 00:00:00 2001
From: Nathan Chancellor <nathan@kernel.org>
Date: Sat, 18 Dec 2021 17:29:03 -0700
Subject: [PATCH 09/14] Revert "drm/i915/fbc: Register per-crtc debugfs files"

This reverts commit e74c6aa955caedd06b5ade58e31e33338e4efde6.

Link: https://lore.kernel.org/r/Yb6EP13FeEhmvq5c@archlinux-ax161/
Signed-off-by: Nathan Chancellor <nathan@kernel.org>
---
 .../drm/i915/display/intel_display_debugfs.c  |  7 ++---
 drivers/gpu/drm/i915/display/intel_fbc.c      | 31 +++++++------------
 drivers/gpu/drm/i915/display/intel_fbc.h      |  1 -
 3 files changed, 14 insertions(+), 25 deletions(-)

diff --git a/drivers/gpu/drm/i915/display/intel_display_debugfs.c b/drivers/gpu/drm/i915/display/intel_display_debugfs.c
index f4de004d470f..572445299b04 100644
--- a/drivers/gpu/drm/i915/display/intel_display_debugfs.c
+++ b/drivers/gpu/drm/i915/display/intel_display_debugfs.c
@@ -2402,9 +2402,6 @@ void intel_connector_debugfs_add(struct intel_connector *intel_connector)
  */
 void intel_crtc_debugfs_add(struct drm_crtc *crtc)
 {
-	if (!crtc->debugfs_entry)
-		return;
-
-	crtc_updates_add(crtc);
-	intel_fbc_crtc_debugfs_add(to_intel_crtc(crtc));
+	if (crtc->debugfs_entry)
+		crtc_updates_add(crtc);
 }
diff --git a/drivers/gpu/drm/i915/display/intel_fbc.c b/drivers/gpu/drm/i915/display/intel_fbc.c
index 987ea4c4b5d0..53c93387710c 100644
--- a/drivers/gpu/drm/i915/display/intel_fbc.c
+++ b/drivers/gpu/drm/i915/display/intel_fbc.c
@@ -1798,32 +1798,25 @@ DEFINE_SIMPLE_ATTRIBUTE(intel_fbc_debugfs_false_color_fops,
 			intel_fbc_debugfs_false_color_set,
 			"%llu\n");
 
-static void intel_fbc_debugfs_add(struct intel_fbc *fbc,
-				  struct dentry *parent)
+static void intel_fbc_debugfs_add(struct intel_fbc *fbc)
 {
-	debugfs_create_file("i915_fbc_status", 0444, parent,
-			    fbc, &intel_fbc_debugfs_status_fops);
+	struct drm_i915_private *i915 = fbc->i915;
+	struct drm_minor *minor = i915->drm.primary;
 
-	if (fbc->funcs->set_false_color)
-		debugfs_create_file("i915_fbc_false_color", 0644, parent,
-				    fbc, &intel_fbc_debugfs_false_color_fops);
-}
+	debugfs_create_file("i915_fbc_status", 0444,
+			    minor->debugfs_root, fbc,
+			    &intel_fbc_debugfs_status_fops);
 
-void intel_fbc_crtc_debugfs_add(struct intel_crtc *crtc)
-{
-	struct intel_plane *plane = to_intel_plane(crtc->base.primary);
-
-	if (plane->fbc)
-		intel_fbc_debugfs_add(plane->fbc, crtc->base.debugfs_entry);
+	if (fbc->funcs->set_false_color)
+		debugfs_create_file("i915_fbc_false_color", 0644,
+				    minor->debugfs_root, fbc,
+				    &intel_fbc_debugfs_false_color_fops);
 }
 
-/* FIXME: remove this once igt is on board with per-crtc stuff */
 void intel_fbc_debugfs_register(struct drm_i915_private *i915)
 {
-	struct drm_minor *minor = i915->drm.primary;
-	struct intel_fbc *fbc;
+	struct intel_fbc *fbc = i915->fbc[INTEL_FBC_A];
 
-	fbc = i915->fbc[INTEL_FBC_A];
 	if (fbc)
-		intel_fbc_debugfs_add(fbc, minor->debugfs_root);
+		intel_fbc_debugfs_add(fbc);
 }
diff --git a/drivers/gpu/drm/i915/display/intel_fbc.h b/drivers/gpu/drm/i915/display/intel_fbc.h
index 8c5a7339a27f..7b7631aec527 100644
--- a/drivers/gpu/drm/i915/display/intel_fbc.h
+++ b/drivers/gpu/drm/i915/display/intel_fbc.h
@@ -42,7 +42,6 @@ void intel_fbc_flush(struct drm_i915_private *dev_priv,
 void intel_fbc_add_plane(struct intel_fbc *fbc, struct intel_plane *plane);
 void intel_fbc_handle_fifo_underrun_irq(struct drm_i915_private *i915);
 void intel_fbc_reset_underrun(struct drm_i915_private *i915);
-void intel_fbc_crtc_debugfs_add(struct intel_crtc *crtc);
 void intel_fbc_debugfs_register(struct drm_i915_private *i915);
 
 #endif /* __INTEL_FBC_H__ */
-- 
2.34.1

