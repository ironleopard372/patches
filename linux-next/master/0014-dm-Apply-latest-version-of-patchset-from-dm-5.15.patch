From bb1186535f0711a1d9e1e0bb1e19bd9209e90fd1 Mon Sep 17 00:00:00 2001
From: Nathan Chancellor <nathan@kernel.org>
Date: Sun, 25 Jul 2021 16:50:10 -0700
Subject: [PATCH 14/16] dm: Apply latest version of patchset from dm-5.15

Link: https://lists.01.org/hyperkitty/list/kbuild-all@lists.01.org/message/YXDCQ3ABRCMKHAEGGG5EQ6PG445RAZBX/
Link: https://lore.kernel.org/r/202107211307.WaOQR1zv-lkp@intel.com/
Link: https://git.kernel.org/pub/scm/linux/kernel/git/device-mapper/linux-dm.git/log/?h=dm-5.15
Signed-off-by: Nathan Chancellor <nathan@kernel.org>
---
 drivers/md/dm-ima.c  | 5 +++--
 drivers/md/dm-raid.c | 1 +
 2 files changed, 4 insertions(+), 2 deletions(-)

diff --git a/drivers/md/dm-ima.c b/drivers/md/dm-ima.c
index 706140d4a9f7..2d796e439bee 100644
--- a/drivers/md/dm-ima.c
+++ b/drivers/md/dm-ima.c
@@ -183,7 +183,7 @@ void dm_ima_measure_on_table_load(struct dm_table *table, unsigned int status_fl
 	size_t cur_total_buf_len = 0;
 	unsigned int num_targets, i;
 	SHASH_DESC_ON_STACK(shash, NULL);
-	struct crypto_shash *tfm;
+	struct crypto_shash *tfm = NULL;
 	u8 *digest = NULL;
 	bool noio = false;
 
@@ -342,7 +342,8 @@ void dm_ima_measure_on_table_load(struct dm_table *table, unsigned int status_fl
 	kfree(device_data_buf);
 exit:
 	kfree(digest);
-	crypto_free_shash(tfm);
+	if (tfm)
+		crypto_free_shash(tfm);
 	kfree(ima_buf);
 	kfree(target_metadata_buf);
 	kfree(target_data_buf);
diff --git a/drivers/md/dm-raid.c b/drivers/md/dm-raid.c
index 75829ddad60e..d9ef52159a22 100644
--- a/drivers/md/dm-raid.c
+++ b/drivers/md/dm-raid.c
@@ -3683,6 +3683,7 @@ static void raid_status(struct dm_target *ti, status_type_t type,
 
 		/* Access most recent mddev properties for status output */
 		smp_rmb();
+		recovery = rs->md.recovery;
 		state = decipher_sync_action(mddev, recovery);
 		DMEMIT(",raid_state=%s", sync_str(state));
 
-- 
2.32.0.264.g75ae10bc75

