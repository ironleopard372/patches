From 3d8b895fa31cde38627d431d040944c1fd157b51 Mon Sep 17 00:00:00 2001
From: Nathan Chancellor <natechancellor@gmail.com>
Date: Wed, 4 Mar 2020 12:26:34 -0700
Subject: [PATCH 25/25] io_uring: Apply diff from current HEAD and
 axboe/for-next

Signed-off-by: Nathan Chancellor <natechancellor@gmail.com>
---
 fs/io_uring.c | 5 +++--
 1 file changed, 3 insertions(+), 2 deletions(-)

diff --git a/fs/io_uring.c b/fs/io_uring.c
index d7c42bd04c78..ec486c24e523 100644
--- a/fs/io_uring.c
+++ b/fs/io_uring.c
@@ -3404,6 +3404,9 @@ static int io_close(struct io_kiocb *req, bool force_nonblock)
 
 	/* if the file has a flush method, be safe and punt to async */
 	if (req->close.put_file->f_op->flush && force_nonblock) {
+		/* submission ref will be dropped, take it for async */
+		refcount_inc(&req->refs);
+
 		req->work.func = io_close_finish;
 		/*
 		 * Do manual async queue here to avoid grabbing files - we don't
@@ -3411,8 +3414,6 @@ static int io_close(struct io_kiocb *req, bool force_nonblock)
 		 * the file again and cause a double CQE entry for this request
 		 */
 		io_queue_async_work(req);
-		/* submission ref will be dropped, take it for async */
-		refcount_inc_not_zero(&req->refs);
 		return 0;
 	}
 
-- 
2.25.1

