From f56c9d53bd88d619f4b65a24b002728946f891d6 Mon Sep 17 00:00:00 2001
From: Nathan Chancellor <natechancellor@gmail.com>
Date: Thu, 28 May 2020 13:53:49 -0700
Subject: [PATCH 35/35] refperf: Avoid 64-bit division errors on 32-bit
 platforms

Signed-off-by: Nathan Chancellor <natechancellor@gmail.com>
---
 kernel/rcu/refperf.c | 8 ++++++--
 1 file changed, 6 insertions(+), 2 deletions(-)

diff --git a/kernel/rcu/refperf.c b/kernel/rcu/refperf.c
index 47df72c492b3..f029eaefc930 100644
--- a/kernel/rcu/refperf.c
+++ b/kernel/rcu/refperf.c
@@ -386,7 +386,8 @@ static int main_func(void *arg)
 		if (torture_must_stop())
 			goto end;
 
-		result_avg[exp] = 1000 * process_durations(nreaders) / (nreaders * loops);
+		result_avg[exp] = div64_ul(1000 * process_durations(nreaders),
+					   nreaders * loops);
 	}
 
 	// Print the average of all experiments
@@ -397,9 +398,12 @@ static int main_func(void *arg)
 	strcat(buf, "Threads\tTime(ns)\n");
 
 	for (exp = 0; exp < nruns; exp++) {
+		u64 result;
+		u32 remain;
 		if (errexit)
 			break;
-		sprintf(buf1, "%d\t%llu.%03d\n", exp + 1, result_avg[exp] / 1000, (int)(result_avg[exp] % 1000));
+		result = div_u64_rem(result_avg[exp], 1000, &remain);
+		sprintf(buf1, "%d\t%llu.%03u\n", exp + 1, result, remain);
 		strcat(buf, buf1);
 	}
 
-- 
2.27.0.rc0

