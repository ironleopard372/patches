From ae40a8cde72ab1b5e2607ccf7b479acca4e42819 Mon Sep 17 00:00:00 2001
From: Nathan Chancellor <natechancellor@gmail.com>
Date: Mon, 30 Mar 2020 14:37:38 -0700
Subject: [PATCH 17/18] Revert "mm/hmm: remove the CONFIG_TRANSPARENT_HUGEPAGE
 #ifdef"

This reverts commit d7cd7ac3bb4a8f5bcf644e4edd78a0a47435c476.

Link: https://lore.kernel.org/lkml/20200330200823.GH8514@mellanox.com/
Signed-off-by: Nathan Chancellor <natechancellor@gmail.com>
---
 mm/hmm.c | 6 ++++++
 1 file changed, 6 insertions(+)

diff --git a/mm/hmm.c b/mm/hmm.c
index 31d0f68689c3..280585833adf 100644
--- a/mm/hmm.c
+++ b/mm/hmm.c
@@ -187,6 +187,7 @@ static inline uint64_t pmd_to_hmm_pfn_flags(struct hmm_range *range, pmd_t pmd)
 				range->flags[HMM_PFN_VALID];
 }
 
+#ifdef CONFIG_TRANSPARENT_HUGEPAGE
 static int hmm_vma_handle_pmd(struct mm_walk *walk, unsigned long addr,
 		unsigned long end, uint64_t *pfns, pmd_t pmd)
 {
@@ -209,6 +210,11 @@ static int hmm_vma_handle_pmd(struct mm_walk *walk, unsigned long addr,
 	hmm_vma_walk->last = end;
 	return 0;
 }
+#else /* CONFIG_TRANSPARENT_HUGEPAGE */
+/* stub to allow the code below to compile */
+int hmm_vma_handle_pmd(struct mm_walk *walk, unsigned long addr,
+		unsigned long end, uint64_t *pfns, pmd_t pmd);
+#endif /* CONFIG_TRANSPARENT_HUGEPAGE */
 
 static inline bool hmm_is_device_private_entry(struct hmm_range *range,
 		swp_entry_t entry)
-- 
2.26.0

