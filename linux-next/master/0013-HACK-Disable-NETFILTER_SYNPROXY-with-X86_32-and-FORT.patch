From 948ac94c975762e2b6a91686499c75d9145dfdfe Mon Sep 17 00:00:00 2001
From: Nathan Chancellor <nathan@kernel.org>
Date: Thu, 26 Aug 2021 17:08:27 -0700
Subject: [PATCH 13/18] HACK: Disable NETFILTER_SYNPROXY with X86_32 and
 !FORTIFY_SOURCE

Link: https://github.com/ClangBuiltLinux/linux/issues/1442
Signed-off-by: Nathan Chancellor <nathan@kernel.org>
---
 net/ipv4/netfilter/Kconfig | 2 ++
 net/ipv6/netfilter/Kconfig | 2 ++
 net/netfilter/Kconfig      | 2 ++
 3 files changed, 6 insertions(+)

diff --git a/net/ipv4/netfilter/Kconfig b/net/ipv4/netfilter/Kconfig
index 63cb953bd019..6390cb590c94 100644
--- a/net/ipv4/netfilter/Kconfig
+++ b/net/ipv4/netfilter/Kconfig
@@ -203,6 +203,8 @@ config IP_NF_TARGET_REJECT
 config IP_NF_TARGET_SYNPROXY
 	tristate "SYNPROXY target support"
 	depends on NF_CONNTRACK && NETFILTER_ADVANCED
+	# https://github.com/ClangBuiltLinux/linux/issues/1442
+	depends on !(CC_IS_CLANG && X86_32 && !FORTIFY_SOURCE)
 	select NETFILTER_SYNPROXY
 	select SYN_COOKIES
 	help
diff --git a/net/ipv6/netfilter/Kconfig b/net/ipv6/netfilter/Kconfig
index f22233e44ee9..331a5d439f56 100644
--- a/net/ipv6/netfilter/Kconfig
+++ b/net/ipv6/netfilter/Kconfig
@@ -216,6 +216,8 @@ config IP6_NF_TARGET_REJECT
 config IP6_NF_TARGET_SYNPROXY
 	tristate "SYNPROXY target support"
 	depends on NF_CONNTRACK && NETFILTER_ADVANCED
+	# https://github.com/ClangBuiltLinux/linux/issues/1442
+	depends on !(CC_IS_CLANG && X86_32 && !FORTIFY_SOURCE)
 	select NETFILTER_SYNPROXY
 	select SYN_COOKIES
 	help
diff --git a/net/netfilter/Kconfig b/net/netfilter/Kconfig
index 3646fc195e7d..e1d035e032c0 100644
--- a/net/netfilter/Kconfig
+++ b/net/netfilter/Kconfig
@@ -671,6 +671,8 @@ config NFT_TPROXY
 config NFT_SYNPROXY
 	tristate "Netfilter nf_tables SYNPROXY expression support"
 	depends on NF_CONNTRACK && NETFILTER_ADVANCED
+	# https://github.com/ClangBuiltLinux/linux/issues/1442
+	depends on !(CC_IS_CLANG && X86_32 && !FORTIFY_SOURCE)
 	select NETFILTER_SYNPROXY
 	select SYN_COOKIES
 	help
-- 
2.34.1

